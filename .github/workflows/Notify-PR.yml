name: Notify Slack on PR with Bot

on:
  pull_request:
    types: [opened, reopened, review_requested]
  issue_comment:
    types: [ created ]
  pull_request_review_comment:
    types: [ created ]
  pull_request_review:
    types: [ submitted ]

jobs:
  Notify-Slack:
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack Message with Mention
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          # GitHub ë¦¬ë·°ì–´ ì´ë¦„ â†’ ìŠ¬ë™ ì‚¬ìš©ì ID ìˆ˜ë™ ë§¤í•‘
          declare -A user_map
          user_map["Park-Jae-Min"]="U096UP6APFF"

          REVIEWERS=$(echo '${{ toJson(github.event.pull_request.requested_reviewers) }}' | jq -r '.[].login')
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          
          case "${{ github.event_name }}" in
            "pull_request")
              MENTIONS=""
              for reviewer in $REVIEWERS; do
                SLACK_ID="${user_map[$reviewer]}"
                if [ -n "$SLACK_ID" ]; then
                  MENTIONS+="<@$SLACK_ID> "
                fi
              done
    
              TEXT="ğŸ”” *PR ë¦¬ë·° ìš”ì²­*
              ë¦¬ë·°ì–´: $MENTIONS
              *PR ì •ë³´*
              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
              ğŸ“Œ *ì œëª©:* ${{ github.event.pull_request.title }}
              ğŸ‘¤ *ì‘ì„±ì:* $PR_AUTHOR
              ğŸŒ¿ *ë¸Œëœì¹˜:* \`$SOURCE_BRANCH\` â†’ \`$TARGET_BRANCH\`
              ğŸ”— *PR ë§í¬:* ${{ github.event.pull_request.html_url }}
              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n
              "

              curl -X POST https://slack.com/api/chat.postMessage \
                -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                -H 'Content-type: application/json' \
                --data "{
                  \"channel\": \"$SLACK_CHANNEL_ID\",
                  \"text\": \"$TEXT\",
                  \"blocks\": [
                    {
                      \"type\": \"section\",
                      \"text\": {
                        \"type\": \"mrkdwn\",
                        \"text\": \"$TEXT\"
                      }
                    }
                  ]
                }"
              ;;
            
            "issue_comment"|"pull_request_review_comment"|"pull_request_review")
              # ì½”ë©˜íŠ¸ ì‘ì„±ì ì •ë³´
              if [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
                COMMENT_AUTHOR="${{ github.event.review.user.login }}"
                COMMENT_TEXT="${{ github.event.review.body }}"
                COMMENT_TYPE="ë¦¬ë·°"
              else
                COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
                COMMENT_TEXT="${{ github.event.comment.body }}"
                COMMENT_TYPE="ì½”ë©˜íŠ¸"
              fi

              AUTHOR_SLACK_ID="${user_map[$COMMENT_AUTHOR]}"
              if [ -z "$AUTHOR_SLACK_ID" ]; then
                AUTHOR_SLACK_ID=$COMMENT_AUTHOR
              fi

              # Slack ì±„ë„ íˆìŠ¤í† ë¦¬ì—ì„œ ì›ë³¸ PR ë©”ì‹œì§€ ê²€ìƒ‰
              SEARCH_RESPONSE=$(curl -s -X GET \
                "https://slack.com/api/search.messages?query=PR+%23${PR_NUMBER}+in%3A${SLACK_CHANNEL_ID}&sort=timestamp&sort_dir=desc" \
                -H "Authorization: Bearer $SLACK_BOT_TOKEN")
          
              # ë©”ì‹œì§€ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì¶œ
              ORIGINAL_TS=$(echo $SEARCH_RESPONSE | jq -r '.messages.matches[] | select(.text | contains("PR #'${PR_NUMBER}'")) | .ts' | head -n 1)
              echo ORIGINAL_TS

              if [ -n "$ORIGINAL_TS" ]; then
                # ì“°ë ˆë“œ ë©”ì‹œì§€ ì‘ì„±
                THREAD_TEXT="ğŸ’¬ *ìƒˆë¡œìš´ ${COMMENT_TYPE}*\nğŸ‘¤ ì‘ì„±ì: <@$AUTHOR_SLACK_ID>\nâ”â”â”â”â”â”â”â”â”â”\n$COMMENT_TEXT"

                curl -X POST https://slack.com/api/chat.postMessage \
                  -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                  -H 'Content-type: application/json' \
                  --data "{
                    \"channel\": \"$SLACK_CHANNEL_ID\",
                    \"thread_ts\": \"$ORIGINAL_TS\",
                    \"text\": \"$THREAD_TEXT\"
                  }"
              fi
            ;;
          esac

